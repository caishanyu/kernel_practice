# helloWorld模块

本目录中实现一个最简单的内核驱动模块

目录

- [基础知识](#基础知识)
- [Makefile](#makefile)
- [加载卸载模块](#加载卸载模块)
- [模块参数](#模块参数)

## 基础知识

每个内核模块都必须包含一个`init()`和`exit()`函数，前者在驱动加载时执行，后者在驱动卸载时执行

`init()`让操作系统知道驱动具备怎么样的能力，以及具体事件发生时（比如将驱动注册到总线、注册一个字符设备）调用驱动的哪个函数

`exit()`函数必须释放所有在`init()`函数中请求的资源

`module_init()`和`module_exit()`宏负责指定具体的入口和出口函数

还有一些宏用于指定模块的各种属性，比如必须指定许可证标记`MODULE_LICENSE`，如果没有设置为某种GPL许可证标记，那么加载模块时linux内核会被污染

## Makefile

代码构建使用的Makefile，与平时写用户程序差别较大，具体看文件中的注释

运行`make`后生成.ko以及.o等中间文件，可通过`make clean`删除所有产物

## 加载卸载模块

`sudo insmod xxx.ko`用于加载模块

`sudo rmmod xxx.ko`用于卸载模块

内核打印必须在内核日志中查看，标准输出是不会直接打印的，可以通过`sudo dmseg | tail`查看

## 模块参数

许多Linux可加载内核模块都可以在加载时、系统启动时或者系统运行时设置参数

模块参数的定义通过`module_param(name, type, perm)`宏实现，允许在模块加载时通过命令行指定参数，或者模块加载完毕后通过sysfs文件系统修改参数（如果参数设置为可写）

1. `name`：参数名，必须是全局变量
2. `type`：参数类型
3. `perm`：权限标志，常用有：`0`-只能通过加载参数写入；`S_IRUGO`-所有用户可读；`S_IWUSR`-用户可写；`S_IRUGO | S_IWUSR`-用户可读写

比如本目录的模块，加载时指定

```bash
sudo insmod helloworld.ko num=10
```

查看日志可以看到`num`为我们指定的10